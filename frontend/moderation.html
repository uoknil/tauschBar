<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>tauschBar ‚Äì Moderation</title>
  <link rel="stylesheet" href="./landing-page.css" />
  <link rel="stylesheet" href="./app-styles.css" />
</head>
<body>
  <nav class="app-nav">
    <div class="app-nav-container">
      <a class="brand" href="./dashboard.html">tauschBar</a>
      <div class="nav-links">
        <a href="./dashboard.html">Dashboard</a>
        <a href="./moderation.html">Moderation</a>
      </div>
    </div>
  </nav>

  <div class="page-container">
    <div class="page-header">
      <h1 class="page-title">üõ°Ô∏è Moderation</h1>
      <p class="page-subtitle">Verwalte gemeldete Eintr√§ge und setze Ma√ünahmen</p>
    </div>

    <div class="app-card" style="margin-bottom: 32px;">
      <h3 style="font-size: 18px; font-weight: 700; margin: 0 0 16px 0;">üîê Authentifizierung</h3>
      <div class="form-group">
        <label for="modToken">Moderations-Token</label>
        <input id="modToken" placeholder="MOD_TOKEN eingeben..." />
      </div>
      <button id="loadBtn" class="btn btn-primary">Meldungen laden</button>
    </div>

    <h2 style="font-size: 24px; font-weight: 700; margin: 0 0 20px 0;">üìã Gemeldete Eintr√§ge</h2>
    <ul id="reports" class="app-list"></ul>
  </div>

  <script>
    const reportsUl = document.getElementById('reports');
    const modTokenInput = document.getElementById('modToken');
    const loadBtn = document.getElementById('loadBtn');

    async function loadReports() {
      reportsUl.innerHTML = '<li>Lade...</li>';

      const modToken = modTokenInput.value.trim();
      if (!modToken) {
        reportsUl.innerHTML = '<li>Bitte MOD_TOKEN eingeben.</li>';
        return;
      }

      const res = await fetch('http://localhost:3000/reports', {
        headers: { 'X-MOD-TOKEN': modToken }
      });

      const data = await res.json().catch(() => ([]));

      if (!res.ok) {
        reportsUl.innerHTML = `<li>${data.message || 'Fehler beim Laden.'}</li>`;
        return;
      }

      if (!data.length) {
        reportsUl.innerHTML = '<li>Keine Meldungen vorhanden.</li>';
        return;
      }

      reportsUl.innerHTML = '';

      for (const r of data) {
        const li = document.createElement('li');

        const entryTitle = r.entryId?.title || '(Entry gel√∂scht?)';
        const entryCat = r.entryId?.category || '';
        const reporter = r.reportedBy?.username || '(unbekannt)';
        const reportId = r._id;

        li.innerHTML = `
          <strong>Status:</strong> ${r.status}<br/>
          <strong>Eintrag:</strong> ${entryTitle} (${entryCat})<br/>
          <strong>Gemeldet von:</strong> ${reporter}<br/>
          <strong>Grund:</strong> ${r.reason}<br/>
          <strong>Details:</strong> ${r.details || '-'}<br/>
          <small>${new Date(r.createdAt).toLocaleString()}</small><br/>

          <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
            <button class="blockBtn" data-id="${reportId}">Eintrag sperren</button>
            <button class="warnBtn" data-id="${reportId}">User verwarnen</button>
            <button class="closeBtn" data-id="${reportId}">Schlie√üen</button>
          </div>
          <hr/>
        `;

        reportsUl.appendChild(li);
      }
    }

    async function doAction(reportId, action) {
      const modToken = modTokenInput.value.trim();
      const note = prompt('Moderations-Notiz (optional):') || '';

      let payload = { action, note };

      if (action === 'blockEntry') {
        const blockReason = prompt('Sperrgrund (optional):') || '';
        payload.blockReason = blockReason;
      }

      const res = await fetch(`http://localhost:3000/reports/${reportId}/action`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'X-MOD-TOKEN': modToken
        },
        body: JSON.stringify(payload)
      });

      const data = await res.json().catch(() => ({}));

      if (!res.ok) {
        alert((data.message || 'Aktion fehlgeschlagen.') + (data.error ? `\n\n${data.error}` : ''));
        return;
      }

      alert(data.message || 'OK');
      loadReports();
    }

    reportsUl.addEventListener('click', (ev) => {
      const btn = ev.target;
      const id = btn.getAttribute('data-id');
      if (!id) return;

      if (btn.classList.contains('blockBtn')) return doAction(id, 'blockEntry');
      if (btn.classList.contains('warnBtn')) return doAction(id, 'warnUser');
      if (btn.classList.contains('closeBtn')) return doAction(id, 'close');
    });

    loadBtn.addEventListener('click', loadReports);
  </script>
</body>
</html>
