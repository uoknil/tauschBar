<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>tauschBar ‚Äì Eintrag erstellen</title>
  <link rel="stylesheet" href="../css/main.css" />
  <script src="../js/categories.js"></script>
  <style>
    .page-header-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .mode-toggle-section {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .mode-toggle-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 16px;
    }

    .mode-buttons {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .mode-btn {
      flex: 1;
      padding: 14px 20px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.3s;
    }

    .mode-btn:hover {
      border-color: #c0c0c0;
    }

    .mode-btn.active-offer {
      background: #4caf50;
      color: white;
      border-color: #4caf50;
    }

    .mode-btn.active-request {
      background: #ff9800;
      color: white;
      border-color: #ff9800;
    }

    .mode-info {
      padding: 16px;
      border-radius: 8px;
      display: flex;
      align-items: start;
      gap: 12px;
      font-size: 14px;
      line-height: 1.5;
    }

    .mode-info.offer-mode {
      background: rgba(76, 175, 80, 0.1);
      border-left: 4px solid #4caf50;
    }

    .mode-info.request-mode {
      background: rgba(255, 152, 0, 0.1);
      border-left: 4px solid #ff9800;
    }

    .mode-info strong {
      display: block;
      margin-bottom: 4px;
    }

    .form-section {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .form-section h2 {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-dark);
      margin: 0 0 20px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 8px;
      font-size: 14px;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s;
      box-sizing: border-box;
      font-family: inherit;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.1);
    }

    .form-group textarea {
      min-height: 120px;
      resize: vertical;
    }

    .form-group small {
      display: block;
      margin-top: 6px;
      color: var(--text-light);
      font-size: 13px;
    }

    .description-section {
      border: 3px solid #e0e0e0;
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s;
    }

    .description-section.offer-active {
      border-color: #4caf50;
    }

    .description-section.request-active {
      border-color: #ff9800;
    }

    .description-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      font-size: 16px;
      font-weight: 700;
    }

    .description-header.offer-color {
      color: #4caf50;
    }

    .description-header.request-color {
      color: #ff9800;
    }

    .btn-group {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .btn {
      padding: 14px 28px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 16px;
      flex: 1;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(108, 92, 231, 0.3);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: #e0e0e0;
      color: var(--text-dark);
    }

    .btn-secondary:hover {
      background: #d0d0d0;
    }

    .alert {
      padding: 14px 18px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
      animation: slideDown 0.3s ease-out;
    }

    .alert.show {
      display: block;
    }

    .alert.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 768px) {
      .mode-buttons {
        flex-direction: column;
      }

      .btn-group {
        flex-direction: column;
      }

      .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <nav class="app-nav">
    <div class="app-nav-container">
      <a class="brand" href="../index.html">tauschBar</a>
      <div class="nav-links">
        <span id="navUser" style="font-weight: 600;"></span>
        <a href="./dashboard.html">Dashboard</a>
        <a href="./create-entry.html" class="btn-primary-nav">+ Eintrag erstellen</a>
        <a href="./chat.html">Chat</a>
        <a href="./profile.html">Profil</a>
        <button id="logoutBtn" class="btn">Logout</button>
      </div>
    </div>
  </nav>

  <div class="page-container-narrow">
    <!-- Alert Messages -->
    <div id="alertSuccess" class="alert success"></div>
    <div id="alertError" class="alert error"></div>

    <!-- Page Header -->
    <div class="page-header">
      <div class="page-header-icon" id="pageIcon">üéÅ</div>
      <h1 class="page-title" id="pageTitle">Hilfe anbieten</h1>
      <p class="page-subtitle" id="pageSubtitle">Teile deine F√§higkeiten und Zeit mit der Nachbarschaft</p>
    </div>

    <form id="entryForm">
      <!-- Mode Selection -->
      <div class="mode-toggle-section">
        <div class="mode-toggle-title">Was m√∂chtest du tun?</div>
        
        <div class="mode-buttons">
          <button type="button" class="mode-btn active-offer" id="btnOffer">
            üéÅ Ich biete Hilfe an
          </button>
          <button type="button" class="mode-btn" id="btnRequest">
            üîç Ich suche Hilfe
          </button>
        </div>

        <div class="mode-info offer-mode" id="modeInfo">
          <span style="font-size: 20px;">üéÅ</span>
          <div>
            <strong>Hilfe anbieten</strong>
            Du m√∂chtest deine F√§higkeiten, Zeit oder Werkzeuge mit der Nachbarschaft teilen? Perfekt! Beschreibe einfach, was du anbietest.
          </div>
        </div>
      </div>

      <!-- Basic Information -->
      <div class="form-section">
        <h2>
          <span>üìù</span>
          Grundinformationen
        </h2>
        
        <div class="form-group">
          <label>Titel *</label>
          <input 
            name="title" 
            id="titleInput"
            required 
            placeholder="z.B. Einkaufshilfe anbieten"
            maxlength="100"
          />
          <small id="titleHint">Kurze Beschreibung deines Angebots</small>
        </div>

        <div class="form-group">
          <label>Kategorie *</label>
          <select name="category" id="categorySelect" required>
            <option value="">Bitte w√§hle eine Kategorie...</option>
          </select>
          <small id="categoryHint">W√§hle die Kategorie f√ºr den Angebot</small>
        </div>
      </div>

      <!-- Description Section -->
      <div class="description-section offer-active" id="descriptionSection">
        <div class="description-header offer-color" id="descriptionHeader">
          <span id="descriptionIcon">üéÅ</span>
          <span id="descriptionTitle">Was bietest du an?</span>
        </div>
        
        <div class="form-group">
          <label id="descriptionLabel">Deine F√§higkeiten & Angebote *</label>
          <textarea 
            name="description" 
            id="descriptionTextarea"
            required
            placeholder="Ich kann f√ºr dich einkaufen gehen"
            maxlength="500"
          ></textarea>
          <small id="descriptionHint">z.B. "Ich kann f√ºr dich einkaufen gehen, mit deinem Hund spazieren oder beim Umzug helfen."</small>
        </div>
      </div>

      <!-- Location -->
      <div class="form-section">
        <h2>
          <span>üìç</span>
          Standort
        </h2>
        
        <div class="form-group">
          <label>PLZ *</label>
          <input 
            id="zipInput" 
            name="zip" 
            required 
            placeholder="z.B. 1010"
            pattern="[0-9]{4,5}"
            maxlength="5"
          />
          <small>Deine genaue Adresse bleibt privat. Die PLZ wird nur f√ºr die Umkreissuche verwendet.</small>
        </div>
      </div>

      <!-- Hidden field for entryType -->
      <input type="hidden" name="entryType" id="entryType" value="offer">

      <!-- Submit Buttons -->
      <div class="btn-group">
        <button type="submit" class="btn btn-primary" id="submitBtn">
          ‚úÖ Eintrag erstellen
        </button>
        <button type="button" class="btn btn-secondary" id="cancelBtn">
          ‚ùå Abbrechen
        </button>
      </div>
    </form>
  </div>

  <script>
    // Elements
    const form = document.getElementById('entryForm');
    const logoutBtn = document.getElementById('logoutBtn');
    const navUser = document.getElementById('navUser');
    const categorySelect = document.getElementById('categorySelect');
    const submitBtn = document.getElementById('submitBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const alertSuccess = document.getElementById('alertSuccess');
    const alertError = document.getElementById('alertError');

    // Mode elements
    const btnOffer = document.getElementById('btnOffer');
    const btnRequest = document.getElementById('btnRequest');
    const modeInfo = document.getElementById('modeInfo');
    const entryTypeInput = document.getElementById('entryType');
    
    // Dynamic content elements
    const pageIcon = document.getElementById('pageIcon');
    const pageTitle = document.getElementById('pageTitle');
    const pageSubtitle = document.getElementById('pageSubtitle');
    const descriptionSection = document.getElementById('descriptionSection');
    const descriptionHeader = document.getElementById('descriptionHeader');
    const descriptionIcon = document.getElementById('descriptionIcon');
    const descriptionTitle = document.getElementById('descriptionTitle');
    const descriptionLabel = document.getElementById('descriptionLabel');
    const descriptionTextarea = document.getElementById('descriptionTextarea');
    const descriptionHint = document.getElementById('descriptionHint');
    const titleInput = document.getElementById('titleInput');
    const titleHint = document.getElementById('titleHint');
    const categoryHint = document.getElementById('categoryHint');

    // Auth check
    const username = localStorage.getItem('username');
    const token = localStorage.getItem('token');

    if (!username || !token) {
      window.location.href = './login.html';
    } else {
      navUser.textContent = `Hallo, ${username}`;
    }

    // Current mode
    let currentMode = 'offer';

    // Mode switching
    function switchToOffer() {
      currentMode = 'offer';
      entryTypeInput.value = 'offer';
      
      // Update buttons
      btnOffer.classList.add('active-offer');
      btnOffer.classList.remove('active-request');
      btnRequest.classList.remove('active-offer', 'active-request');
      
      // Update info box
      modeInfo.className = 'mode-info offer-mode';
      modeInfo.innerHTML = `
        <span style="font-size: 20px;">üéÅ</span>
        <div>
          <strong>Hilfe anbieten</strong>
          Du m√∂chtest deine F√§higkeiten, Zeit oder Werkzeuge mit der Nachbarschaft teilen? Perfekt! Beschreibe einfach, was du anbietest.
        </div>
      `;
      
      // Update page header
      pageIcon.textContent = 'üéÅ';
      pageTitle.textContent = 'Hilfe anbieten';
      pageSubtitle.textContent = 'Teile deine F√§higkeiten und Zeit mit der Nachbarschaft';
      
      // Update description section
      descriptionSection.className = 'description-section offer-active';
      descriptionHeader.className = 'description-header offer-color';
      descriptionIcon.textContent = 'üéÅ';
      descriptionTitle.textContent = 'Was bietest du an?';
      descriptionLabel.textContent = 'Deine F√§higkeiten & Angebote *';
      descriptionTextarea.placeholder = 'Ich kann f√ºr dich einkaufen gehen';
      descriptionHint.textContent = 'z.B. "Ich kann f√ºr dich einkaufen gehen, mit deinem Hund spazieren oder beim Umzug helfen."';
      
      // Update other hints
      titleInput.placeholder = 'z.B. Einkaufshilfe anbieten';
      titleHint.textContent = 'Kurze Beschreibung deines Angebots';
      categoryHint.textContent = 'W√§hle die Kategorie f√ºr den Angebot';
    }

    function switchToRequest() {
      currentMode = 'request';
      entryTypeInput.value = 'request';
      
      // Update buttons
      btnRequest.classList.add('active-request');
      btnRequest.classList.remove('active-offer');
      btnOffer.classList.remove('active-offer', 'active-request');
      
      // Update info box
      modeInfo.className = 'mode-info request-mode';
      modeInfo.innerHTML = `
        <span style="font-size: 20px;">üîç</span>
        <div>
          <strong>Hilfe suchen</strong>
          Du brauchst Unterst√ºtzung in einem bestimmten Bereich? Kein Problem! Beschreibe einfach, was du suchst.
        </div>
      `;
      
      // Update page header
      pageIcon.textContent = 'üîç';
      pageTitle.textContent = 'Hilfe suchen';
      pageSubtitle.textContent = 'Finde Nachbarn, die dir weiterhelfen k√∂nnen';
      
      // Update description section
      descriptionSection.className = 'description-section request-active';
      descriptionHeader.className = 'description-header request-color';
      descriptionIcon.textContent = 'üîç';
      descriptionTitle.textContent = 'Was suchst du?';
      descriptionLabel.textContent = 'Dein Bedarf & W√ºnsche *';
      descriptionTextarea.placeholder = 'Ich kann f√ºr dich einkaufen gehen';
      descriptionHint.textContent = 'z.B. "Ich brauche Hilfe beim Umzug, beim Reparieren meines Fahrrads oder beim Erlernen einer neuen Sprache."';
      
      // Update other hints
      titleInput.placeholder = 'z.B. Einkaufshilfe gesucht';
      titleHint.textContent = 'Kurze Beschreibung deines Gesuchs';
      categoryHint.textContent = 'W√§hle die Kategorie f√ºr dein Gesuch';
    }

    btnOffer.addEventListener('click', switchToOffer);
    btnRequest.addEventListener('click', switchToRequest);

    // Show/hide alerts
    function showSuccess(message) {
      alertSuccess.textContent = message;
      alertSuccess.classList.add('show');
      alertError.classList.remove('show');
      setTimeout(() => alertSuccess.classList.remove('show'), 5000);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function showError(message) {
      alertError.textContent = message;
      alertError.classList.add('show');
      alertSuccess.classList.remove('show');
      setTimeout(() => alertError.classList.remove('show'), 5000);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // Load Categories
    if (window.CATEGORIES) {
      window.CATEGORIES.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.name;
        option.textContent = `${cat.icon} ${cat.name}`;
        categorySelect.appendChild(option);
      });
    } else {
      console.warn('Categories not loaded!');
      showError('Kategorien konnten nicht geladen werden. Bitte Seite neu laden.');
    }

    // Form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(form);
      const data = {
        title: formData.get('title'),
        entryType: formData.get('entryType'),
        category: formData.get('category'),
        zip: formData.get('zip')
      };

      // Add the appropriate description based on mode
      const description = formData.get('description');
      if (currentMode === 'offer') {
        data.offerDescription = description;
      } else {
        data.requestDescription = description;
      }

      // Validation
      if (!data.title || data.title.trim().length < 5) {
        showError('Titel muss mindestens 5 Zeichen lang sein');
        return;
      }

      if (!description || description.trim().length < 10) {
        showError('Beschreibung muss mindestens 10 Zeichen lang sein');
        return;
      }

      if (!data.zip || !/^\d{4,5}$/.test(data.zip)) {
        showError('Bitte gib eine g√ºltige PLZ ein (4-5 Ziffern)');
        return;
      }

      // Disable submit button
      submitBtn.disabled = true;
      submitBtn.textContent = '‚è≥ Wird erstellt...';

      try {
        const res = await fetch('/entries', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(data)
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.message || 'Fehler beim Speichern');
        }

        const created = await res.json();
        
        // Show success message
        showSuccess(`‚úÖ Eintrag erfolgreich erstellt! Du wirst weitergeleitet...`);
        
        // Reset form
        form.reset();
        
        // Clear draft
        localStorage.removeItem('entryDraft');
        
        // Redirect to dashboard after 2 seconds
        setTimeout(() => {
          window.location.href = './dashboard.html';
        }, 2000);

      } catch (error) {
        console.error('Error creating entry:', error);
        showError(error.message || 'Fehler beim Erstellen des Eintrags');
        submitBtn.disabled = false;
        submitBtn.textContent = '‚úÖ Eintrag erstellen';
      }
    });

    // Cancel button
    cancelBtn.addEventListener('click', () => {
      if (confirm('M√∂chtest du wirklich abbrechen? Alle eingegebenen Daten gehen verloren.')) {
        window.location.href = './dashboard.html';
      }
    });

    // Logout
    logoutBtn.addEventListener('click', () => {
      if (confirm('M√∂chtest du dich wirklich abmelden?')) {
        localStorage.removeItem('token');
        localStorage.removeItem('username');
        window.location.href = './login.html';
      }
    });

    // Auto-save to localStorage (draft)
    let autoSaveTimer;
    form.addEventListener('input', () => {
      clearTimeout(autoSaveTimer);
      autoSaveTimer = setTimeout(() => {
        const formData = Object.fromEntries(new FormData(form).entries());
        formData.currentMode = currentMode;
        localStorage.setItem('entryDraft', JSON.stringify(formData));
        console.log('Draft auto-saved');
      }, 2000);
    });

    // Restore draft on load
    window.addEventListener('load', () => {
      const draft = localStorage.getItem('entryDraft');
      if (draft) {
        const shouldRestore = confirm('Es wurde ein Entwurf gefunden. M√∂chtest du ihn wiederherstellen?');
        if (shouldRestore) {
          try {
            const data = JSON.parse(draft);
            
            // Restore mode first
            if (data.currentMode === 'request') {
              switchToRequest();
            } else {
              switchToOffer();
            }
            
            // Restore form fields
            Object.keys(data).forEach(key => {
              const field = form.elements[key];
              if (field && key !== 'currentMode') {
                field.value = data[key];
              }
            });
            
            showSuccess('Entwurf wiederhergestellt!');
          } catch (error) {
            console.error('Error restoring draft:', error);
          }
        }
        localStorage.removeItem('entryDraft');
      }
    });
  </script>
</body>
</html>
