<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>tauschBar â€“ Chat</title>
    <link rel="stylesheet" href="../css/main.css" />
    <style>
      /* Chat Styles */
      .chat-container {
        display: grid;
        grid-template-columns: 350px 1fr;
        gap: 24px;
        padding: 24px 32px;
        max-width: 1400px;
        margin: 0 auto;
        height: calc(100vh - 120px);
      }

      /* Conversations Panel (Sidebar) */
      .conversations-panel {
        background: var(--white);
        border-radius: var(--border-radius);
        border: 1px solid #e5e5e5;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: var(--shadow);
      }

      .conversations-header {
        padding: 20px 24px;
        border-bottom: 1px solid #e5e5e5;
        background: var(--white);
        font-weight: 700;
        font-size: 20px;
        color: var(--text-dark);
      }

      .conversations-list {
        flex: 1;
        overflow-y: auto;
        list-style: none;
        margin: 0;
        padding: 0;
      }

      .conversation-item {
        padding: 16px 20px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 12px;
        position: relative;
      }

      .conversation-item:hover {
        background: var(--bg-light);
      }

      .conversation-item.active {
        background: rgba(0, 188, 212, 0.1);
        border-left: 4px solid var(--primary-color);
      }

      .conversation-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--secondary-color)
        );
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 16px;
        flex-shrink: 0;
      }

      .conversation-info {
        flex: 1;
        min-width: 0;
      }

      .conversation-partner {
        font-weight: 600;
        font-size: 15px;
        color: var(--text-dark);
        margin-bottom: 2px;
      }

      .conversation-entry {
        font-size: 12px;
        color: var(--text-light);
        margin-bottom: 4px;
      }

      .conversation-preview {
        font-size: 13px;
        color: var(--text-light);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .conversation-time {
        font-size: 11px;
        color: var(--text-light);
        margin-top: 4px;
      }

      .unread-badge {
        display: inline-block;
        background: #f44336;
        color: white;
        border-radius: 12px;
        padding: 3px 8px;
        font-size: 11px;
        font-weight: 700;
        position: absolute;
        top: 16px;
        right: 16px;
      }

      /* Chat Panel (Main) */
      .chat-panel {
        background: var(--white);
        border-radius: var(--border-radius);
        border: 1px solid #e5e5e5;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: var(--shadow);
      }

      .chat-header {
        padding: 20px 24px;
        border-bottom: 1px solid #e5e5e5;
        background: var(--white);
      }

      .chat-header h3 {
        margin: 0 0 4px 0;
        font-size: 18px;
        font-weight: 700;
        color: var(--text-dark);
      }

      .chat-header small {
        color: var(--text-light);
        font-size: 13px;
      }

      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        background: var(--bg-light);
      }

      .message {
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 16px;
        word-wrap: break-word;
        font-size: 15px;
        line-height: 1.5;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message.sent {
        align-self: flex-end;
        background: var(--primary-color);
        color: white;
        border-bottom-right-radius: 4px;
      }

      .message.received {
        align-self: flex-start;
        background: white;
        color: var(--text-dark);
        border: 1px solid #e5e5e5;
        border-bottom-left-radius: 4px;
      }

      .message-time {
        font-size: 11px;
        opacity: 0.7;
        margin-top: 4px;
        color: inherit;
      }

      .message.sent .message-time {
        text-align: right;
      }

      /* Input Area */
      .chat-input-area {
        padding: 20px 24px;
        border-top: 1px solid #e5e5e5;
        display: flex;
        gap: 12px;
        background: var(--white);
      }

      .chat-input-area textarea {
        flex: 1;
        resize: none;
        padding: 12px 20px;
        border: 2px solid #e5e5e5;
        border-radius: 12px;
        font-family: inherit;
        font-size: 15px;
        transition: all 0.2s;
        min-height: 44px;
        max-height: 120px;
      }

      .chat-input-area textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(0, 188, 212, 0.1);
      }

      .chat-input-area button {
        padding: 12px 28px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        font-size: 15px;
        transition: all 0.3s;
        align-self: flex-end;
      }

      .chat-input-area button:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 188, 212, 0.3);
      }

      .chat-input-area button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      /* Empty States */
      .chat-placeholder {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--text-light);
        text-align: center;
        padding: 60px 40px;
      }

      .chat-placeholder-icon {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: 0.5;
      }

      .chat-placeholder h3 {
        margin: 0 0 12px 0;
        font-size: 20px;
        font-weight: 700;
        color: var(--text-dark);
      }

      .chat-placeholder p {
        margin: 0;
        font-size: 15px;
        color: var(--text-light);
      }

      .no-conversations {
        padding: 40px 20px;
        text-align: center;
        color: var(--text-light);
      }

      /* Responsive */
      @media (max-width: 768px) {
        .chat-container {
          grid-template-columns: 1fr;
          gap: 16px;
          padding: 16px;
          height: calc(100vh - 80px);
        }

        .conversations-panel {
          max-height: 300px;
        }

        .chat-panel {
          min-height: 500px;
        }

        .message {
          max-width: 85%;
        }
      }
    </style>
  </head>
  <body>
    <nav class="app-nav">
      <div class="app-nav-container">
        <a class="brand" href="../index.html">tauschBar</a>
        <div class="nav-links">
          <span id="navUser" style="font-weight: 600"></span>
          <a href="./dashboard.html">Dashboard</a>
          <a href="./create-entry.html" class="btn-primary-nav"
            >+ Eintrag erstellen</a
          >
          <a href="./chat.html" style="position: relative">
            Chat
            <span
              id="navUnreadBadge"
              class="badge badge-primary"
              style="display: none; margin-left: 4px"
              >0</span
            >
          </a>
          <a href="./profile.html">Profil</a>
          <button id="logoutBtn" class="btn">Logout</button>
        </div>
      </div>
    </nav>

    <!--<h1>Chat</h1>-->

    <div class="chat-container">
      <!-- Linke Seite: Konversationen -->
      <div class="conversations-panel">
        <div class="conversations-header">
          Meine Chats
          <button
            id="refreshBtn"
            style="float: right; padding: 2px 8px; font-size: 12px"
          >
            â†»
          </button>
        </div>
        <ul class="conversations-list" id="conversationsList">
          <li class="no-conversations">Lade...</li>
        </ul>
      </div>

      <!-- Rechte Seite: Chat -->
      <div class="chat-panel" id="chatPanel">
        <div class="chat-placeholder" id="chatPlaceholder">
          WÃ¤hle eine Konversation aus oder starte einen neuen Chat vom
          Dashboard.
        </div>

        <!-- Wird dynamisch angezeigt -->
        <div
          id="chatContent"
          style="display: none; flex-direction: column; height: 100%"
        >
          <div class="chat-header" id="chatHeader">
            <h3 id="chatPartnerName">-</h3>
            <small id="chatEntryInfo">-</small>
          </div>

          <div class="chat-messages" id="chatMessages">
            <!-- Nachrichten werden hier eingefÃ¼gt -->
          </div>

          <div class="chat-input-area">
            <textarea
              id="messageInput"
              rows="2"
              placeholder="Nachricht schreiben..."
            ></textarea>
            <button id="sendBtn">Senden</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ============================================================
      // Globale Variablen
      // ============================================================
      const API_BASE = 'http://localhost:3000';
      let currentConversation = null; // { visavisId, entryId, partnerName }
      let currentUserId = null;

      // DOM-Elemente
      const conversationsList = document.getElementById('conversationsList');
      const chatPlaceholder = document.getElementById('chatPlaceholder');
      const chatContent = document.getElementById('chatContent');
      const chatHeader = document.getElementById('chatHeader');
      const chatPartnerName = document.getElementById('chatPartnerName');
      const chatEntryInfo = document.getElementById('chatEntryInfo');
      const chatMessages = document.getElementById('chatMessages');
      const messageInput = document.getElementById('messageInput');
      const sendBtn = document.getElementById('sendBtn');
      const refreshBtn = document.getElementById('refreshBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const loginLink = document.getElementById('loginLink');
      const navUnreadBadge = document.getElementById('navUnreadBadge');

      // ============================================================
      // Auth-Check
      // ============================================================
      const token = localStorage.getItem('token');
      const username = localStorage.getItem('username');

      if (!token || !username) {
        window.location.href = './login.html';
      } else {
        if (loginLink) loginLink.style.display = 'none';
        const navUser = document.getElementById('navUser');
        if (navUser) navUser.textContent = `Hallo, ${username}`;
        // User-ID aus Token extrahieren (JWT Payload)
        try {
          const payload = JSON.parse(atob(token.split('.')[1]));
          currentUserId = payload.userId;
        } catch (e) {
          console.error('Token parsing failed:', e);
        }
      }

      // ============================================================
      // API-Helfer
      // ============================================================
      async function apiFetch(endpoint, options = {}) {
        const headers = {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`,
          ...options.headers,
        };

        const res = await fetch(`${API_BASE}${endpoint}`, {
          ...options,
          headers,
        });
        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          throw new Error(data.message || 'API-Fehler');
        }

        return data;
      }

      // ============================================================
      // Konversationen laden
      // ============================================================
      async function loadConversations() {
        conversationsList.innerHTML =
          '<li class="no-conversations">Lade...</li>';

        try {
          const conversations = await apiFetch('/messages/conversations');

          if (!conversations.length) {
            conversationsList.innerHTML =
              '<li class="no-conversations">Noch keine Chats vorhanden.<br><br><small>Starte einen Chat vom Dashboard Ã¼ber den "Kontakt"-Button bei einem Eintrag.</small></li>';
            return;
          }

          conversationsList.innerHTML = '';

          for (const conv of conversations) {
            const li = document.createElement('li');
            li.className = 'conversation-item';
            li.dataset.visavisId = conv.partner._id;
            li.dataset.entryId = conv.entry ? conv.entry._id : '';
            li.dataset.partnerName = conv.partner.username;

            const unreadBadge =
              conv.unreadCount > 0
                ? `<span class="unread-badge">${conv.unreadCount}</span>`
                : '';

            const entryTitle = conv.entry
              ? conv.entry.title
              : '(Eintrag gelÃ¶scht)';
            const lastMsgTime = new Date(
              conv.lastMessage.createdAt,
            ).toLocaleString('de-DE', {
              day: '2-digit',
              month: '2-digit',
              hour: '2-digit',
              minute: '2-digit',
            });

            li.innerHTML = `
            <div class="conversation-partner">
              ${conv.partner.username} ${unreadBadge}
            </div>
            <div class="conversation-entry">ðŸ“¦ ${entryTitle}</div>
            <div class="conversation-preview">${conv.lastMessage.content}</div>
            <div class="conversation-time">${lastMsgTime}</div>
          `;

            li.addEventListener('click', () => {
              openConversation(
                conv.partner._id,
                conv.entry ? conv.entry._id : '',
                conv.partner.username,
                entryTitle,
              );
            });

            conversationsList.appendChild(li);
          }

          // Aktive Konversation markieren
          if (currentConversation) {
            markActiveConversation(
              currentConversation.visavisId,
              currentConversation.entryId,
            );
          }
        } catch (err) {
          console.error('Konversationen laden fehlgeschlagen:', err);
          conversationsList.innerHTML =
            '<li class="no-conversations">Fehler beim Laden.</li>';
        }
      }

      // ============================================================
      // Konversation Ã¶ffnen
      // ============================================================
      async function openConversation(
        visavisId,
        entryId,
        partnerName,
        entryTitle,
      ) {
        currentConversation = { visavisId, entryId, partnerName };

        // UI umschalten
        chatPlaceholder.style.display = 'none';
        chatContent.style.display = 'flex';

        chatPartnerName.textContent = `Chat mit ${partnerName}`;
        chatEntryInfo.textContent = `Zu: ${entryTitle || '(Eintrag)'}`;

        // Aktive Markierung setzen
        markActiveConversation(visavisId, entryId);

        // Nachrichten laden
        await loadMessages(visavisId, entryId);

        // Ungelesene Badge aktualisieren
        await updateUnreadBadge();
        await loadConversations(); // Liste neu laden fÃ¼r Badge-Update
      }

      // ============================================================
      // Nachrichten laden
      // ============================================================
      async function loadMessages(visavisId, entryId) {
        chatMessages.innerHTML =
          '<div style="text-align:center; color:#999;">Lade Nachrichten...</div>';

        try {
          const messages = await apiFetch(
            `/messages/conversation/${visavisId}/${entryId}`,
          );

          if (!messages.length) {
            chatMessages.innerHTML =
              '<div style="text-align:center; color:#999;">Noch keine Nachrichten. Schreibe die erste!</div>';
            return;
          }

          chatMessages.innerHTML = '';

          for (const msg of messages) {
            const isSent = String(msg.sender._id) === String(currentUserId);
            const div = document.createElement('div');
            div.className = `message ${isSent ? 'sent' : 'received'}`;

            const time = new Date(msg.createdAt).toLocaleString('de-DE', {
              day: '2-digit',
              month: '2-digit',
              hour: '2-digit',
              minute: '2-digit',
            });

            div.innerHTML = `
            <div class="message-content">${escapeHtml(msg.content)}</div>
            <div class="message-time">${time}</div>
          `;

            chatMessages.appendChild(div);
          }

          // Zum Ende scrollen
          chatMessages.scrollTop = chatMessages.scrollHeight;
        } catch (err) {
          console.error('Nachrichten laden fehlgeschlagen:', err);
          chatMessages.innerHTML =
            '<div style="text-align:center; color:#c00;">Fehler beim Laden der Nachrichten.</div>';
        }
      }

      // ============================================================
      // Nachricht senden
      // ============================================================
      async function sendMessage() {
        if (!currentConversation) {
          alert('Bitte wÃ¤hle zuerst eine Konversation.');
          return;
        }

        const content = messageInput.value.trim();
        if (!content) return;

        sendBtn.disabled = true;

        try {
          await apiFetch('/messages', {
            method: 'POST',
            body: JSON.stringify({
              entryId: currentConversation.entryId,
              receiverId: currentConversation.visavisId,
              content,
            }),
          });

          messageInput.value = '';

          // Nachrichten neu laden
          await loadMessages(
            currentConversation.visavisId,
            currentConversation.entryId,
          );

          // Konversationsliste aktualisieren (fÃ¼r letzte Nachricht)
          await loadConversations();
        } catch (err) {
          console.error('Senden fehlgeschlagen:', err);
          alert('Nachricht konnte nicht gesendet werden: ' + err.message);
        } finally {
          sendBtn.disabled = false;
        }
      }

      // ============================================================
      // Ungelesene Nachrichten Badge
      // ============================================================
      async function updateUnreadBadge() {
        try {
          const data = await apiFetch('/messages/unread-count');
          const count = data.unreadCount || 0;

          if (count > 0) {
            navUnreadBadge.textContent = count;
            navUnreadBadge.style.display = 'inline-block';
          } else {
            navUnreadBadge.style.display = 'none';
          }
        } catch (err) {
          console.error('Unread count error:', err);
        }
      }

      // ============================================================
      // Hilfsfunktionen
      // ============================================================
      function markActiveConversation(visavisId, entryId) {
        document.querySelectorAll('.conversation-item').forEach((item) => {
          item.classList.remove('active');
          if (
            item.dataset.visavisId === visavisId &&
            item.dataset.entryId === entryId
          ) {
            item.classList.add('active');
          }
        });
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // ============================================================
      // URL-Parameter prÃ¼fen (fÃ¼r direkten Chat-Start vom Dashboard)
      // ============================================================
      async function checkUrlParams() {
        const params = new URLSearchParams(window.location.search);
        const entryId = params.get('entry');
        const partnerId = params.get('partner');

        if (entryId && partnerId) {
          try {
            // Entry-Info laden
            const entryInfo = await apiFetch(`/messages/entry-info/${entryId}`);
            openConversation(
              partnerId,
              entryId,
              entryInfo.owner.username,
              entryInfo.title,
            );
          } catch (err) {
            console.error('URL-Params verarbeiten fehlgeschlagen:', err);
          }
        }
      }

      // ============================================================
      // Event Listeners
      // ============================================================
      sendBtn.addEventListener('click', sendMessage);

      messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      refreshBtn.addEventListener('click', async () => {
        await loadConversations();
        if (currentConversation) {
          await loadMessages(
            currentConversation.visavisId,
            currentConversation.entryId,
          );
        }
        await updateUnreadBadge();
      });

      logoutBtn.addEventListener('click', () => {
        localStorage.removeItem('token');
        localStorage.removeItem('username');
        window.location.href = './login.html';
      });

      // ============================================================
      // Initialisierung
      // ============================================================
      (async function init() {
        await loadConversations();
        await updateUnreadBadge();
        await checkUrlParams();

        // Auto-Refresh alle 30 Sekunden
        setInterval(async () => {
          await loadConversations();
          if (currentConversation) {
            await loadMessages(
              currentConversation.visavisId,
              currentConversation.entryId,
            );
          }
          await updateUnreadBadge();
        }, 30000);
      })();
    </script>
  </body>
</html>
