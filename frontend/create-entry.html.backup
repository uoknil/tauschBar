<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>tauschBar – Eintrag erstellen</title>
  <link rel="stylesheet" href="./style.css" />
  <link rel="stylesheet" href="./style2.css" />
  <script src="./categories.js"></script>
</head>
<body>
  <script>
    // Debug: Sofort prüfen ob categories.js geladen wurde
    console.log('create-entry.html: window.CATEGORIES =', window.CATEGORIES);
    console.log('create-entry.html: CATEGORIES verfügbar =', typeof window.CATEGORIES !== 'undefined');
  </script>
  <nav class="nav">
    <a class="brand" href="./dashboard.html">tauschBar</a>

    <div class="links">
      <a href="./dashboard.html">Dashboard</a>
      <a href="./create-entry.html">Neuer Eintrag</a>
      <a href="./profile.html">Profil</a>
      <a href="./login.html" id="loginLink">Login</a>
      <button id="logoutBtn" class="linkBtn">Logout</button>
    </div>
  </nav>

  <h1>Eintrag erstellen (Angebot + Gesuch)</h1>

  <form id="entryForm">
    <div>
      <label>Titel</label><br />
      <input name="title" required />
    </div>

    <div>
      <label>Angebot (Was bietest du?)</label><br />
      <textarea name="offerDescription" required></textarea>
    </div>

    <div>
      <label>Gesuch (Was brauchst du?)</label><br />
      <textarea name="requestDescription" required></textarea>
    </div>

    <div>
      <label>Kategorie</label><br />
      <select name="category" id="categorySelect" required>
        <option value="">Bitte wählen...</option>
      </select>
    </div>

    <!-- PLZ + Zeitraum (müssen name= haben!) -->
    <div>
      <label>PLZ</label><br />
      <input id="zipInput" name="zip" required placeholder="z.B. 1010" />
    </div>

    <div>
      <label>Zeitraum von</label><br />
      <input id="fromInput" name="availableFrom" type="date" required />
    </div>

    <div>
      <label>Zeitraum bis</label><br />
      <input id="toInput" name="availableTo" type="date" />
      <small style="display:block; margin-top:4px;">
        (optional – wenn leer, wird automatisch „von“ verwendet)
      </small>
    </div>

    <button type="submit">Speichern</button>
  </form>

  <p id="result"></p>

  <p>
    <a href="./dashboard.html">→ Zur Übersicht (Dashboard)</a>
  </p>

  <script>
    const form = document.getElementById('entryForm');
    const logoutBtn = document.getElementById('logoutBtn');
    const loginLink = document.getElementById('loginLink');
    const categorySelect = document.getElementById('categorySelect');

    const username = localStorage.getItem('username');
    const tokenStored = localStorage.getItem('token');

    if (!username || !tokenStored) {
      logoutBtn.style.display = 'none';
    } else {
      loginLink.style.display = 'none';
    }

    const result = document.getElementById('result');
    
    // Load Categories
    if (window.CATEGORIES) {
      window.CATEGORIES.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.name;
        option.textContent = `${cat.icon} ${cat.name}`;
        categorySelect.appendChild(option);
      });
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const data = Object.fromEntries(new FormData(form).entries());

      // Minimal robust: wenn availableTo leer ist -> availableFrom verwenden
      if (!data.availableTo) {
        data.availableTo = data.availableFrom;
      }

      const token = localStorage.getItem('token');

      if (!token) {
        alert('Bitte zuerst einloggen.');
        window.location.href = './login.html';
        return;
      }

      const res = await fetch('http://localhost:3000/entries', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(data)
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        result.textContent = 'Fehler beim Speichern.' + (err.message ? ` (${err.message})` : '');
        return;
      }

      const created = await res.json();
      result.textContent = `Gespeichert! ID: ${created._id || created.id}`;
      form.reset();
    });

    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('token');
      localStorage.removeItem('username');
      window.location.href = './login.html';
    });
  </script>
</body>
</html>
